---
title: 移动端适配的前世今生
date: 2017-10-09 22:22:22
categories:
- WEB前端
tags: 
- HTML
comments: true
---

>**综述：**本文结合各方观点，意在详解**viewport**这个抽象而又复杂的概念，由于网上针对这个词的言论和解释已经非常泛滥，有深有浅，良莠不齐，造成很多人的误解和疑惑，在此，本文立足一些现有的权威解读，结合实践，以浏览器发展历史为贯穿轴线，争取解释清楚这个名词真正的意义所在。

<!-- more -->

## 一.PPK大神对pc端viewport的讨论

>PPK大神是荷兰Amsterdam公司的移动平台架构师 —— Peter-Paul Koch，维护着浏览器兼容性查询网站 —— QuirksMode.org。

### 1.设备像素与css像素

在100%缩放情况下，一个css像素完全等于一个设备像素（覆盖比例1:1），当用户缩放浏览器，只是css像素在缩放，css相对于设备像素在增大或缩小覆盖比例。

### 2.屏幕尺寸（`screen.width/height`）

此度量值为用户设备的物理像素值，永远不会变，因为它是显示器的属性，而不是浏览器的。

### 3.窗口尺寸（`window.innerwidth/innerheight`）

此值为用户浏览器可放入(此处可以缩放)的css像素点，以css像素为度量，用户缩放浏览器会导致此值变大或变小。

### 4.窗口滚动距离（`window.pageX/YOffset`）

此值为用户在浏览器中将页面滚动的距离，以css像素为度量；浏览器为了保持连贯，会在用户缩放时将页面最顶部的可见元素保持在相同的位置，这就意味着缩放不会导致该值的改变。

### 5.`viewport`

* viewport是用来约束页面对顶级块元素——html元素的，也就是说html的宽度是以隐形的viewport为基准的（通常是100%），而viewport实际上等于浏览器窗口。
* 既然viewport等于浏览器窗口宽高，那么是否可以通过同样是css为度量的`window.innerwidth`来获取宽/高度值呢？二者是有区别的：后者包含滚动条（二者很大程度上是浏览器战争的产物）。
* 那么如何获取到viewport的宽/高呢？虽然`document.documentElement` 指向`html`元素，但是viewport也同样映射在该对象上，为了区分及正确表现html与viewport，该对象中的某些属性做了一些兼容。
* 很有意思，这个viewport会在你页面初始化时就确定一个准确的值，当用户缩放页面时，该值并不会改变，所以会出现缩放后有些元素溢出html的现象。
* 通过`document.documentElement.clientWidth/Heigth`获取`viewport`的宽高。
* 通过`document.documentElement.offsetWidth/offsetHeight`获取html宽高。
* 基于事件中坐标的获取，通过`e.clientX/Y`获取事件相对于viewport的位置，`e.pageX/Y`获取事件相对于html的位置。

>以上，都是针对的PC浏览器而言，未提及任何移动端相关的适配、兼容以及移动端的viewport标签，ok，以上浏览器还停留在PC端，后面逐渐出现了平板以及移动端，那么情况就发生了很大的改变。

## 二.平板和移动端

>当我们习惯了在pc上进行布局，pc端的电脑屏幕是足够宽的，当平板出现时，我们为了兼容平板，出现了响应式的概念，我们终于可以将页面铺满整个屏幕，用百分比来实现适配，效果非常不错。前面说过，元素是基于html的，html是基于viewport的，而viewport就是浏览器窗口的尺寸，然而，当移动端出现的时候， 我们发现如果还是沿用百分比布局， 那么在移动端就会挤作一团，毕竟移动端的浏览器窗口太小了。

### 1.两个视口

**定义：**如果在移动端使用百分比时，能想办法不以浏览器窗口作为viewport的限制，而另外确立视口，那么情况就迎刃而解了，于是出现了另一种视口。我们把浏览器窗口所代表的视口称为`visual viewport`，把新出现的移动端放大版的布局基准视口称为`layout viewport`。
**联系：**`visual viewport`相当于窗口（大小位置可变化），我们通过窗口看到外面的景色，`layout viewport`就是外面的美景，我们通过放大或缩小窗户，来看到更多或更少的景色。
**layout大小：**每个浏览器都不一样，Safari iPhone为980px、Opera为850px、AndroidWebKit为800px、最后IE为974px。

### 2.度量`layout viewport`

同PC端，通过`document.documentElement.clientWidth/clientHeight`获取`layout viewport`的宽高。

### 3.度量`visula viewport`

在PC端有个雷同的度量叫`window.innerWidth/innerHeight`还记得吗？它在移动端可以用来判断`visula viewport`的宽高。

### 4.屏幕尺寸`screen.width/height`

**原文：**ppk大神原文中指出此值与PC端一致，提供以设备像素为单位的屏幕尺寸。
**注意：**此时，还没有出现高分屏，屏幕css像素与物理像素一致 ，后来出现了高分屏以及理想视口的概念，该值也随之发生了变化，PPK大神后面的文章也有说明。

### 5.滚动距离`window.pageX/YOffset`

该值仍然为页面的滚动的距离，然而，这里指的是`visual viewport`相对于`layout viewport`所处的位置。

### 6.度量`html`

通过`document.documentElement.offsetWidth/offsetHeight`获取`html`元素的宽高

### 7.事件坐标

* 通过`e.pageX/Y`获取事件相对于`html`的位置
* 通过`e.clientX/Y`获取事件相对于`visula viewport`的位置
* 通过`e.screenX/Y`获取事件相对于屏幕的位置，同样，此时还没有高分屏，该值是以物理像素为度量的。

>至此，通过两个视口的概念，PC端页面终于能够在移动端完美展现了，百分比布局也不会缩作一团，但是这时候在移动端浏览器中展现的只是缩小版的PC页面，用户需要不断缩放和移动页面来浏览。那我们能否做到让页面在移动像PC端一样，只需要向下滚动就能有好且大小适宜地展现呢？

## 三.移动端页面

>为了做出专属于移动端的页面，我们需要思考几个问题，第一，移动浏览器既要兼容pc端页面展示，又要展示移动端页面；第二，移动端屏幕设备每家制造商都不同，设备像素不可能做到统一，那么有没有一种办法，能够统一一种布局尺寸，从而做到在各种尺寸的屏幕上进行移动端页面开发和展示都是同一种效果呢？

### 1.关于`viewport`标签

**背景：**此时，移动端设备分辨率相对较低，苹果为`320px`，其他触摸屏也都是`300px`左右不等。
**关键：**浏览器会在初始情况下以完全缩小的模式来展示任何页面，即窗口`visula viewport`宽度等于`layout viewport`的宽度。
**方法：**
* 既然页面上的内容过小，迫使我们放大才能阅览，那我们能否通过放大页面中的内容去适配layout视口呢？但是各家浏览器的layout视口宽度不一，无法定一个统一的基准。
* 无法放大页面内容去适配，那只能缩小layout视口宽度了，于是苹果公司开发了一个新的mate标签——viewport，用以在页面初始化的时候就改变layout视口的宽度。
**属性：**
* `width/height`是`documentElement.clientWidth/Height`（layout viewport）值的映射；
* `device-width/height`是`screen.width/height`值的映射。
**释义：**其实最开始的版本，是写死`width=320px`，或许是当时的safari浏览器设备像素就是`320px`的原因，后来也被其他移动端浏览器厂商所沿用。
**原理：**我们设置了layout视口宽度后，就可以用`320px`宽度的设计稿去进行布局页面，或用`640px`设计稿，计算像素时除以2就好。
**彩蛋：**这里的`320px`是个遗祸，手机设备像素必然是不断变化的，这个不是长久之计，同时，也为后面的`第三视口（理想视口 ）`留下了悬念。
**后记：**在方法1中，我们说`layout`无法定一个统一基准，思考一下，我们是否可以使用`rem`去按照一个固定宽度（一般为`750px`）的设计稿布局页面，然后通过获取页面的`layout viewport`的宽度去动态改变`body`或`html`的`font-size`值来适配，经过实践，该方法是可行的，表现非常好。当时之所以没有这样做，是因为它出现得太晚了，`rem`是`css3`的新增度量，而`safari`到`5.0`版本才支持部分`css3`属性，当时没办法，那么现在呢？

## 四.理想视口与高分屏

> 当我们在移动端设置了`viewport`，`width=320`之后，我们终于可以按照固定的设计稿去实现统一的样式问题，如果设备的物理像素正好是`320px`这个设置将相当合理，然而现实是，各家手机厂商的屏幕分辨率不尽相同，整体也趋于向高分屏发展，这样，原来的`320px`就不适用了，并且，谁又规定过`320px`是最合适的呢？

### 1.第三视口：理想视口

**背景：**此时，移动端设备分辨率已经有了很大提升，高分屏，超高分屏陆续出现，设备物理像素已经跃升到`640/750`、甚至比肩桌面端。
**定义：**用于规定该浏览器中最合适的布局视口（`ideal viewport`），即应将`layout viewport`设置到的最理想的视口大小。
**取值：**大部分移动厂商都把自家浏览器的理想视口宽度定义为设备像素的整数分之一，即`1/2，1/3，1/4`等等，这样就可以用整数倍的设备像素去代表一个理想视口像素。
**度量：**通过`screen.width/height`获取理想视口的宽高，该值是永远不会改变的，即使用户缩放和移动页面；相应的，事件坐标中的`e.screenX/Y`获取事件相对于理想视口的位置。
**原理：**其实浏览器配置了这个概念，并且做到了事件系统对于理想视口的支持，就是希望开发者和用户通过理想视口的像素去开发和浏览，而不要再去理会设备的物理像素。
**注意：**此时，由于`screen`即代表了理想视口的尺寸，所以`viewport`标签中的`device-width`实际上就是指理想视口的宽度。

### 2.几个概念

* 屏幕尺寸（单位：英寸）：屏幕对角线长度；
* 屏幕分辨率（单位：px）：横纵向上的设备像素点数；
* 屏幕像素密度（苹果：ppi，安卓：dpi）：屏幕每英寸可以显示的像素点数量；
* 密度独立像素（Density Independent Pixels——dip）：理想视口一个单位的css像素就是一个密度独立像素；
* 设备像素比（window.devicePixelRaio）：一个密度独立像素宽度等于多少个设备像素宽度；

>浏览器的故事讲到这里，就已经与目前的情况接轨了，一切的发展都是有章可循，有据可究，可能还是有人一头雾水，解释了这么多，好像也没有说到到底应该如何布局移动端页面，才能完美地适配各种手机屏幕，下面，将针对这一点谈一点实际的应用。

## 五.移动端布局思考

>移动端浏览器跟随手机厂商的不同，衍生出N多种手机屏幕，各种尺寸，各种设备像素比，虽然都是使用同一种UI渲染引擎（`webkit`），但是兼容性问题还是屡见不鲜，丝毫不比兼容桌面端的IE浏览器更省事，本文只考虑如何在移动端做好手机屏幕尺寸的适配，某些浏览器出现的渲染异常等现象，则需要特殊处理，本文不再涉及。

### 1.px布局

**背景：**在本文的第三节中，苹果公司基于自家手机的屏幕尺寸设立了`viewport`标签并设置`width`为`320`，包括随着移动端分辨率越来越大之后，出现的理想视口，其尺寸一般都在`320~450`之间
**原理：**这时候后，如果我们设置`viewport`的`width（layout viewport）`值为`320`或者`device-width`，那么在众多的手机尺寸中，其`width`值都是很相近的，只要我们处理好横向尺寸的比例分配，其他细节只要能兼容一种尺寸的屏幕，那么其他尺寸屏幕也会八九不离十，基本能展现一致。
**做法：**通常的做法是UI提供`640`或`750`的设计稿，然后前端将各元素尺寸除二作为实际的css像素进行布局，这也是最早期应用最广泛的布局方式，乃至现在都有很多项目在使用。

### 2.px+媒体查询布局

**原理：**这是一种结合了`响应式`的概念的`px`布局方式，通过媒体查询做到控制粒度更细一些 ，能够让`px`布局更加精细。

### 3.px+flex布局

**原理：**这种方式是融合了最先进的`css3`的`flex`布局的概念，其实`flex`除了本身具有一些包含对齐、排列等渲染方式的特殊属性之外，也包含了百分比布局的属性，使得`flex`布局更加方便快捷，但是在某些低端安卓机会有兼容性问题。

### 4.百分比布局

**原理：**这中布局方式除了文字之外，会大幅使用百分比最为横向尺寸布局单位，这样能够做到页面在各种尺寸的屏幕上横向比例都是一定的，是从`响应式的栅格系统`借鉴的经验。

### 5.rem布局

**背景：**在本文第四节中，各浏览器厂商设置了自家浏览器的理想视口的宽度值，通常是当前屏幕设备尺寸的整数分之一，当然，我们也可以直接通过设置`window.devicePixelRaio`来让理想视口尺寸等于设备尺寸，来忽略掉理想视口的尺寸，同时，`css3`大范围推广之后，`rem`作为新的布局单位被发掘出使用价值
**原理：**这种方式是基于`rem`作为布局单位的，`rem`可以让页面各元素的尺寸基于文档根标签的`font-size`值来确定，这样，我们可以在布局的时候采用一种通用的尺寸作为基准，而页面渲染时，再根据用户手机屏幕尺寸，来设置根字体大小，页面各元素的尺寸也会变化。
**做法：**UI提供`750`或更大分辨率的设计稿，尺寸最好是苹果手机理想视口的整数倍，前端根据设计稿和对应苹果机型来布局页面，并在跟标签设置易于计算的`font-size`值，页面所有单位使用`rem`作为单位，布局好页面后，在页面`head`中用js计算打开该页面的用户手机屏幕尺寸，然后算出该尺寸与设计稿尺寸的比例值，以该比例来缩放根标签的`font-size`值，即可做到在各个尺寸的页面上完美兼容，展现一致。
**注意：**这种布局方式特别适合固定尺寸的页面设计稿，如果尺寸未知，无法计算出具体的`rem`值或者有部分内容为明显的按比例评分等，则可以灵活采用百分比的方式布局；再如有细节出现1个像素的尺寸则要考虑一下使用`rem`很有可能造成某些低端安卓机渲染不出来；还有就是字体大小，这个字体大小说的是页面各元素中的字体大小，如果也使用`rem`，会造成在大屏机上，字特别大，而这不一定是UI想要的效果，所以有些项目中会根据实际情况适量结合媒体查询去设置各个元素的实际字体大小。
**衍生：**现在市面上还有一种`rem`布局方式，是直接把设备的设备像素比设置为1，即让设备的理想视口宽度等于设备尺寸，然后在`viewport`中设置`layout viewport`的宽度设置为理想视口即设备像素的宽度，这样，就可以直接以苹果设备的物理像素作为设计稿尺寸来转换成`rem`布局，然后在各个手机屏幕上也这样设置，然后获取屏幕像素值去做比例运算，其实结果与上一种是完全相同的。
**后记续写：**在第三节中，我们留下了一个后记，就是可以不设置`viewport`，因为页面是以最小化展示的，这时候，我们可以放大页面元素，直接根据页面默认的`layout viewport`宽度值来布局，然后屏幕适配也是获取当前屏幕的`layout viewport`的宽度去做比例计算根标签字体值，现在想想，这种方式与衍生版本的不同无非就是是否要将`layout viewport`的值设置为设备像素而已，颇有异曲同工之处，让人有所启迪。